<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tùy chỉnh bản đồ OpenStreetMap</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
    <style>
        #map {
            height: 80vh;
            width: 100%;
        }
    </style>
</head>
<body>

    <h1>OpenStreetMap API Demo</h1>
    <h2>5.1. Geocoding API</h2>
    <div>
        <h3>5.1.1. Geocoding: Chuyển địa chỉ thành tọa độ</h3>
        <input type="text" id="address" placeholder="Nhập địa chỉ...">
        <button onclick="geocode()">Chuyển thành tọa độ</button>
        <p id="geocodeResult"></p>
        
        <h3>5.1.2. Reverse Geocoding: Chuyển tọa độ thành địa chỉ</h3>
        <input type="text" id="latlng" placeholder="Nhập tọa độ (lat,lng)...">
        <button onclick="reverseGeocode()">Chuyển thành địa chỉ</button>
        <p id="reverseGeocodeResult"></p>
    </div>
    <h2>5.3. Places API</h2>
    <div id="map" class="leaflet-container leaflet-touch leaflet-retina leaflet-fade-anim leaflet-grab leaflet-touch-drag leaflet-touch-zoom" tabindex="0" style="position: relative;"><div class="leaflet-pane leaflet-map-pane" style="transform: translate3d(-546px, -214px, 0px);"><div class="leaflet-pane leaflet-tile-pane"><div class="leaflet-layer " style="z-index: 1; opacity: 1;"><div class="leaflet-tile-container leaflet-zoom-animated" style="z-index: 17; transform: translate3d(475px, 375px, 0px) scale(0.5);"></div><div class="leaflet-tile-container leaflet-zoom-animated" style="z-index: 18; transform: translate3d(404px, 257px, 0px) scale(1);"><img alt="" src="https://c.tile.openstreetmap.org/11/1630/961.png" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(104px, -83px, 0px); opacity: 1;"><img alt="" src="https://a.tile.openstreetmap.org/11/1631/961.png" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(360px, -83px, 0px); opacity: 1;"><img alt="" src="https://a.tile.openstreetmap.org/11/1630/962.png" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(104px, 173px, 0px); opacity: 1;"><img alt="" src="https://b.tile.openstreetmap.org/11/1631/962.png" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(360px, 173px, 0px); opacity: 1;"><img alt="" src="https://b.tile.openstreetmap.org/11/1629/961.png" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(-152px, -83px, 0px); opacity: 1;"><img alt="" src="https://b.tile.openstreetmap.org/11/1632/961.png" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(616px, -83px, 0px); opacity: 1;"><img alt="" src="https://c.tile.openstreetmap.org/11/1629/962.png" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(-152px, 173px, 0px); opacity: 1;"><img alt="" src="https://c.tile.openstreetmap.org/11/1632/962.png" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(616px, 173px, 0px); opacity: 1;"><img alt="" src="https://c.tile.openstreetmap.org/11/1631/963.png" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(360px, 429px, 0px); opacity: 1;"><img alt="" src="https://b.tile.openstreetmap.org/11/1630/963.png" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(104px, 429px, 0px); opacity: 1;"><img alt="" src="https://a.tile.openstreetmap.org/11/1632/963.png" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(616px, 429px, 0px); opacity: 1;"><img alt="" src="https://a.tile.openstreetmap.org/11/1633/962.png" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(872px, 173px, 0px); opacity: 1;"><img alt="" src="https://c.tile.openstreetmap.org/11/1633/961.png" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(872px, -83px, 0px); opacity: 1;"><img alt="" src="https://a.tile.openstreetmap.org/11/1629/963.png" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(-152px, 429px, 0px); opacity: 1;"><img alt="" src="https://b.tile.openstreetmap.org/11/1633/963.png" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(872px, 429px, 0px); opacity: 1;"><img alt="" src="https://b.tile.openstreetmap.org/11/1628/962.png" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(-408px, 173px, 0px); opacity: 1;"><img alt="" src="https://b.tile.openstreetmap.org/11/1634/962.png" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(1128px, 173px, 0px); opacity: 1;"><img alt="" src="https://a.tile.openstreetmap.org/11/1628/961.png" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(-408px, -83px, 0px); opacity: 1;"><img alt="" src="https://a.tile.openstreetmap.org/11/1634/961.png" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(1128px, -83px, 0px); opacity: 1;"><img alt="" src="https://c.tile.openstreetmap.org/11/1628/963.png" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(-408px, 429px, 0px); opacity: 1;"><img alt="" src="https://c.tile.openstreetmap.org/11/1634/963.png" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(1128px, 429px, 0px); opacity: 1;"></div></div></div><div class="leaflet-pane leaflet-overlay-pane"></div><div class="leaflet-pane leaflet-shadow-pane"><img src="https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png" class="leaflet-marker-shadow leaflet-zoom-animated" alt="" style="margin-left: -12px; margin-top: -41px; width: 41px; height: 41px; transform: translate3d(663px, 445px, 0px);"><img src="https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png" class="leaflet-marker-shadow leaflet-zoom-animated" alt="" style="margin-left: -12px; margin-top: -41px; width: 41px; height: 41px; transform: translate3d(707px, 535px, 0px);"></div><div class="leaflet-pane leaflet-marker-pane"><img src="https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon-2x.png" class="leaflet-marker-icon leaflet-zoom-animated leaflet-interactive" alt="Marker" tabindex="0" role="button" style="margin-left: -12px; margin-top: -41px; width: 25px; height: 41px; transform: translate3d(663px, 445px, 0px); z-index: 445;"><img src="https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon-2x.png" class="leaflet-marker-icon leaflet-zoom-animated leaflet-interactive" alt="Marker" tabindex="0" role="button" style="margin-left: -12px; margin-top: -41px; width: 25px; height: 41px; transform: translate3d(707px, 535px, 0px); z-index: 535;"><div class="leaflet-marker-icon marker-cluster marker-cluster-small leaflet-zoom-animated leaflet-interactive" tabindex="0" role="button" style="margin-left: -20px; margin-top: -20px; width: 40px; height: 40px; transform: translate3d(659px, 481px, 0px); z-index: 481; opacity: 1;"><div><span>2</span></div></div></div><div class="leaflet-pane leaflet-tooltip-pane"></div><div class="leaflet-pane leaflet-popup-pane"></div><div class="leaflet-proxy leaflet-zoom-animated" style="transform: translate3d(417595px, 246302px, 0px) scale(1024);"></div></div><div class="leaflet-control-container"><div class="leaflet-top leaflet-left"><div class="leaflet-control-zoom leaflet-bar leaflet-control"><a class="leaflet-control-zoom-in" href="#" title="Zoom in" role="button" aria-label="Zoom in" aria-disabled="false"><span aria-hidden="true">+</span></a><a class="leaflet-control-zoom-out" href="#" title="Zoom out" role="button" aria-label="Zoom out" aria-disabled="false"><span aria-hidden="true">−</span></a></div></div><div class="leaflet-top leaflet-right"></div><div class="leaflet-bottom leaflet-left"></div><div class="leaflet-bottom leaflet-right"><div class="leaflet-control-attribution leaflet-control"><a href="https://leafletjs.com" title="A JavaScript library for interactive maps"><svg aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="12" height="8" viewBox="0 0 12 8" class="leaflet-attribution-flag"><path fill="#4C7BE1" d="M0 0h12v4H0z"></path><path fill="#FFD500" d="M0 4h12v3H0z"></path><path fill="#E0BC00" d="M0 7h12v1H0z"></path></svg> Leaflet</a> <span aria-hidden="true">|</span> © OpenStreetMap contributors</div></div></div></div>
    <h3>5.3.1. Tìm kiếm địa điểm theo từ khóa hoặc vị trí</h3>
    <input type="text" id="place" placeholder="Nhập tên địa điểm...">
    <button onclick="searchPlace()">Tìm kiếm</button>
    <ul id="placesResult"></ul>

    <h3>5.4.1. Tính toán khoảng cách giữa nhiều điểm</h3>
    <textarea id="locationsInput" rows="4" cols="50" placeholder="Nhập danh sách tọa độ (lat,lng mỗi dòng)..."></textarea>
    <button onclick="calculateDistances()">Tính khoảng cách</button>
    <ul id="distanceResult"></ul>
    <script>

        const map = L.map('map').setView([10.8231, 106.6297], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);


        // const circle = L.circle([10.8231, 106.6297], {
        //     color: 'blue',
        //     fillColor: '#30f',
        //     fillOpacity: 0.3,
        //     radius: 500
        // }).addTo(map);
        // circle.bindPopup('Vòng tròn này bao quanh Hồ Chí Minh');

        const marker = L.marker([10.8231, 106.6297]).addTo(map);
        // marker.bindPopup('<b>Hồ Chí Minh</b><br>Vị trí này là Hồ Chí Minh').openPopup();

        const markers = L.markerClusterGroup();

        const locations = [
            { lat: 10.8231, lng: 106.6297, name: 'Hồ Chí Minh' },
            { lat: 10.7747, lng: 106.6241, name: 'Tân Bình' },
            { lat: 10.762622, lng: 106.660172, name: 'Quận 1' }
        ];

        locations.forEach(location => {
            const marker = L.marker([location.lat, location.lng]);
            marker.bindPopup(`<b>${location.name}</b><br>Vị trí: (${location.lat}, ${location.lng})`);
            markers.addLayer(marker);
        });


        map.addLayer(markers);


        const groupBounds = markers.getBounds();
        map.fitBounds(groupBounds);


        // map.zoomControl.remove();

        // map.on('zoomend', () => {
        //     alert(`Đã zoom đến mức ${map.getZoom()}`);
        // });
        // map.on('dragend', () => {
        //     const center = map.getCenter();
        //     alert(`Đã kéo bản đồ đến tọa độ: ${center.lat}, ${center.lng}`);
        // });


        async function geocode() {
            const address = document.getElementById('address').value;
            const response = await fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(address)}&format=json&limit=1`);
            const data = await response.json();
            if (data.length > 0) {
                document.getElementById('geocodeResult').innerText = `Tọa độ: ${data[0].lat}, ${data[0].lon}`;
            } else {
                document.getElementById('geocodeResult').innerText = 'Không tìm thấy kết quả.';
            }
        }


        async function reverseGeocode() {
            const latlng = document.getElementById('latlng').value.split(',');
            const lat = latlng[0].trim();
            const lng = latlng[1].trim();
            const response = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lng}&format=json`);
            const data = await response.json();
            document.getElementById('reverseGeocodeResult').innerText = data.display_name || 'Không tìm thấy địa chỉ.';
        }
        
        // async function getDirections(locations) {
        //     if (locations.length < 2) {
        //         alert('Cần ít nhất 2 địa điểm để tạo tuyến đường.');
        //         return;
        //     }
        //     const coords = locations.map(loc => `${loc.lng},${loc.lat}`).join(';');
        //     const response = await fetch(`https://router.project-osrm.org/route/v1/driving/${coords}?overview=full&geometries=geojson`);
        //     const data = await response.json();

        //     if (data.routes.length > 0) {
        //         const route = data.routes[0].geometry;

        //         L.geoJSON(route, {
        //             style: {
        //                 color: 'blue',
        //                 weight: 4
        //             }
        //         }).addTo(map);

        //         console.log('Chi tiết chỉ đường:', data.routes[0]);
        //     } else {
        //         alert('Không tìm thấy tuyến đường.');
        //     }
        // }  
        // getDirections(locations);

        async function searchPlace() {
            const query = document.getElementById('place').value;
            const response = await fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}&format=json&limit=5`);
            const data = await response.json();
            const resultList = document.getElementById('placesResult');
            resultList.innerHTML = ''; // Xóa kết quả cũ

            if (data.length > 0) {
                data.forEach(place => {
                    const listItem = document.createElement('li');
                    listItem.innerText = `${place.display_name} (Tọa độ: ${place.lat}, ${place.lon})`;
                    listItem.onclick = () => {
                        map.setView([place.lat, place.lon], 15); // Di chuyển đến vị trí địa điểm
                        L.marker([place.lat, place.lon]).addTo(map).bindPopup(place.display_name).openPopup();
                    };
                    resultList.appendChild(listItem);
                });
            } else {
                resultList.innerHTML = '<li>Không tìm thấy kết quả.</li>';
            }
        }


        async function calculateDistances() {
            const locationsInput = document.getElementById('locationsInput').value.trim();
            const locations = locationsInput.split('\n').map(line => {
                const [lat, lng] = line.split(',').map(Number);
                return { lat, lng };
            });

            if (locations.length < 2) {
                alert('Cần ít nhất 2 tọa độ để tính toán.');
                return;
            }

            const resultList = document.getElementById('distanceResult');
            resultList.innerHTML = ''; // Xóa kết quả cũ

            for (let i = 0; i < locations.length; i++) {
                for (let j = i + 1; j < locations.length; j++) {
                    const start = locations[i];
                    const end = locations[j];

                    const response = await fetch(`https://router.project-osrm.org/route/v1/driving/${start.lng},${start.lat};${end.lng},${end.lat}?overview=full&geometries=geojson`);
                    const data = await response.json();

                    if (data.routes && data.routes.length > 0) {
                        const route = data.routes[0];
                        const distance = (route.distance / 1000).toFixed(2); // Khoảng cách (km)
                        const duration = (route.duration / 60).toFixed(2); // Thời gian (phút)

                        L.geoJSON(route.geometry, {
                            style: {
                                color: 'blue',
                                weight: 4,
                                opacity: 0.7
                            }
                        }).addTo(map).bindPopup(
                            `Từ điểm ${i + 1} đến điểm ${j + 1}:<br>Khoảng cách: ${distance} km<br>Thời gian: ${duration} phút`
                        );

                        const listItem = document.createElement('li');
                        listItem.innerHTML = `Từ điểm ${i + 1} đến điểm ${j + 1}: Khoảng cách: ${distance} km, Thời gian: ${duration} phút.`;
                        resultList.appendChild(listItem);
                    } else {
                        console.error(`Không thể tính toán tuyến đường từ điểm ${i + 1} đến điểm ${j + 1}`);
                    }
                }
            }

            locations.forEach((loc, index) => {
                L.marker([loc.lat, loc.lng]).addTo(map)
                    .bindPopup(`Điểm ${index + 1}`).openPopup();
            });

            const bounds = locations.map(loc => [loc.lat, loc.lng]);
            map.fitBounds(bounds);
        }
    </script>
</body>
</html>
